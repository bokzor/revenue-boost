{%- comment -%}
  Revenue Boost Auto-loaded Popup Initializer
  This snippet is automatically included on all pages via app embed
  Zero merchant configuration required
{%- endcomment -%}

{%- liquid
  assign app_enabled = true
  assign api_url = ''

  comment
    Check if merchant disabled via metafield
  endcomment
  if shop.metafields.revenue_boost.enabled == false
    assign app_enabled = false
  endif

  comment
    Allow custom API URL via metafield (for development/staging)
  endcomment
  if shop.metafields.revenue_boost.api_url != blank
    assign api_url = shop.metafields.revenue_boost.api_url
  endif

  comment
    Get debug mode setting
  endcomment
  assign debug_mode = shop.metafields.revenue_boost.debug | default: false
-%}

{% if app_enabled %}
<!-- Revenue Boost Popups -->
<script id="revenue-boost-config">
  (function() {
    window.REVENUE_BOOST_CONFIG = window.REVENUE_BOOST_CONFIG || {};

    // Use app proxy (empty apiUrl = use same domain via /apps/revenue-boost)
    // This avoids CORS issues and works even when tunnel URL changes
    {% if api_url != blank %}
      window.REVENUE_BOOST_CONFIG.apiUrl = '{{ api_url }}';
    {% else %}
      window.REVENUE_BOOST_CONFIG.apiUrl = '';  // Empty = use app proxy
    {% endif %}

    window.REVENUE_BOOST_CONFIG.shopDomain = '{{ shop.permanent_domain }}';
    window.REVENUE_BOOST_CONFIG.debug = {{ debug_mode }};

    // Bundle base URL - extract from popup-loader URL
    // This will be something like: https://cdn.shopify.com/extensions/.../assets/
    const loaderUrl = '{{ "popup-loader.bundle.js" | asset_url }}';
    window.REVENUE_BOOST_CONFIG.bundleBaseUrl = loaderUrl.substring(0, loaderUrl.lastIndexOf('/') + 1);

    window.REVENUE_BOOST_CONFIG.customerId = {{ customer.id | json }};
    window.REVENUE_BOOST_CONFIG.customerEmail = {{ customer.email | json }};
    window.REVENUE_BOOST_CONFIG.customerTags = {{ customer.tags | json }};
    window.REVENUE_BOOST_CONFIG.cartToken = {{ cart.token | json }};
    window.REVENUE_BOOST_CONFIG.cartValue = {{ cart.total_price | money_without_currency | json }};
    window.REVENUE_BOOST_CONFIG.cartItemCount = {{ cart.item_count | json }};
    window.REVENUE_BOOST_CONFIG.pageType = '{{ request.page_type }}';
    window.REVENUE_BOOST_CONFIG.pageUrl = '{{ request.path }}';
    window.REVENUE_BOOST_CONFIG.locale = '{{ request.locale.iso_code }}';
    window.REVENUE_BOOST_CONFIG.currency = '{{ cart.currency.iso_code }}';

    {% if template.name == 'product' and product %}
    window.REVENUE_BOOST_CONFIG.productId = '{{ product.id }}';
    window.REVENUE_BOOST_CONFIG.productHandle = '{{ product.handle }}';
    window.REVENUE_BOOST_CONFIG.productTitle = {{ product.title | json }};
    window.REVENUE_BOOST_CONFIG.productPrice = {{ product.price | money_without_currency | json }};
    window.REVENUE_BOOST_CONFIG.productType = {{ product.type | json }};
    window.REVENUE_BOOST_CONFIG.productVendor = {{ product.vendor | json }};
    window.REVENUE_BOOST_CONFIG.productTags = {{ product.tags | json }};
    {% endif %}

    {% if template.name == 'collection' and collection %}
    window.REVENUE_BOOST_CONFIG.collectionId = '{{ collection.id }}';
    window.REVENUE_BOOST_CONFIG.collectionHandle = '{{ collection.handle }}';
    window.REVENUE_BOOST_CONFIG.collectionTitle = {{ collection.title | json }};
    {% endif %}

    // Detect preview mode from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const previewId = urlParams.get('revenue_boost_preview');
    if (previewId) {
      window.REVENUE_BOOST_CONFIG.previewMode = true;
      window.REVENUE_BOOST_CONFIG.previewId = previewId;
    }

    // Session tracking
    const sessionId = sessionStorage.getItem('revenue_boost_session_id') || 
                     'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    sessionStorage.setItem('revenue_boost_session_id', sessionId);
    window.REVENUE_BOOST_CONFIG.sessionId = sessionId;

    // Visit tracking
    const visitCount = parseInt(localStorage.getItem('revenue_boost_visit_count') || '0') + 1;
    localStorage.setItem('revenue_boost_visit_count', visitCount.toString());
    window.REVENUE_BOOST_CONFIG.visitCount = visitCount;
    window.REVENUE_BOOST_CONFIG.isReturningVisitor = visitCount > 1;

    // Device detection
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isTablet = /iPad|Android(?!.*Mobile)/i.test(navigator.userAgent);
    window.REVENUE_BOOST_CONFIG.deviceType = isMobile ? 'mobile' : (isTablet ? 'tablet' : 'desktop');

    // Performance tracking
    window.REVENUE_BOOST_CONFIG.loadTime = Date.now();

    // Always log initialization for debugging
    console.log('[Revenue Boost] üöÄ Config loaded:', {
      shopDomain: window.REVENUE_BOOST_CONFIG.shopDomain,
      pageType: window.REVENUE_BOOST_CONFIG.pageType,
      pageUrl: window.REVENUE_BOOST_CONFIG.pageUrl,
      deviceType: window.REVENUE_BOOST_CONFIG.deviceType,
      customerId: window.REVENUE_BOOST_CONFIG.customerId,
      cartItemCount: window.REVENUE_BOOST_CONFIG.cartItemCount,
      visitCount: window.REVENUE_BOOST_CONFIG.visitCount,
      isReturningVisitor: window.REVENUE_BOOST_CONFIG.isReturningVisitor,
      debug: window.REVENUE_BOOST_CONFIG.debug,
      bundleBaseUrl: window.REVENUE_BOOST_CONFIG.bundleBaseUrl
    });

    if (window.REVENUE_BOOST_CONFIG.debug) {
      console.log('[Revenue Boost] üîç Full config:', window.REVENUE_BOOST_CONFIG);
    }
  })();
</script>
{%- comment -%}
  Load popup bundle (IIFE format for Shopify compatibility)
  Cache-busting version: increment when bundle changes
{%- endcomment -%}
<script src="{{ 'popup-loader.bundle.js' | asset_url }}?v=1" defer></script>
{% endif %}

