{%- comment -%}
  Revenue Boost App Block: Popup Embed
  This is the REQUIRED way to load JavaScript in Shopify theme extensions.
  Shopify does NOT allow automatic script injection via app embeds for security.
{%- endcomment -%}

{% if block.settings.enabled %}
  <div id="revenue-boost-embed" data-shop="{{ shop.permanent_domain }}" style="display: none;">
    <script>
      window.REVENUE_BOOST_CONFIG = window.REVENUE_BOOST_CONFIG || {};
      window.REVENUE_BOOST_CONFIG.apiUrl = '{{ block.settings.api_url | default: '' }}';
      window.REVENUE_BOOST_CONFIG.shopDomain = '{{ shop.permanent_domain }}';
      window.REVENUE_BOOST_CONFIG.debug = {{ block.settings.debug_mode | default: false }};
      window.REVENUE_BOOST_CONFIG.customerId = {{ customer.id | json }};
      window.REVENUE_BOOST_CONFIG.customerEmail = {{ customer.email | json }};
      window.REVENUE_BOOST_CONFIG.customerTags = {{ customer.tags | json }};
      window.REVENUE_BOOST_CONFIG.cartToken = {{ cart.token | json }};
      window.REVENUE_BOOST_CONFIG.pageType = '{{ request.page_type }}';
      window.REVENUE_BOOST_CONFIG.pageUrl = '{{ request.path }}';

      // Detect preview mode from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const previewId = urlParams.get('split_pop_preview');
      const previewToken = urlParams.get('split_pop_preview_token');
      const previewBehavior = urlParams.get('preview_behavior') || 'instant';

      console.log('[Revenue Boost Block] URL:', window.location.href);
      console.log('[Revenue Boost Block] Preview params:', {
        previewId: previewId,
        previewToken: previewToken,
        previewBehavior: previewBehavior
      });

      if (previewId) {
        console.log('[Revenue Boost Block] ✅ Setting preview mode with ID:', previewId);
        window.REVENUE_BOOST_CONFIG.previewMode = true;
        window.REVENUE_BOOST_CONFIG.previewId = previewId;
        window.REVENUE_BOOST_CONFIG.previewBehavior = previewBehavior;
      } else if (previewToken) {
        console.log('[Revenue Boost Block] ✅ Setting preview mode with token:', previewToken);
        window.REVENUE_BOOST_CONFIG.previewMode = true;
        window.REVENUE_BOOST_CONFIG.previewToken = previewToken;
        window.REVENUE_BOOST_CONFIG.previewBehavior = previewBehavior;
      } else {
        console.log('[Revenue Boost Block] ℹ️ No preview parameters found');
      }

      console.log('[Revenue Boost Block] Final config:', {
        previewMode: window.REVENUE_BOOST_CONFIG.previewMode,
        previewId: window.REVENUE_BOOST_CONFIG.previewId,
        previewToken: window.REVENUE_BOOST_CONFIG.previewToken,
        previewBehavior: window.REVENUE_BOOST_CONFIG.previewBehavior
      });
    </script>
    <script src="{{ 'popup-loader.bundle.js' | asset_url }}" defer></script>
  </div>
{% endif %}

{% schema %}
{
  "name": "Revenue Boost Popups",
  "target": "body",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable popups",
      "default": true,
      "info": "Turn off to disable all popups on your store"
    },
    {
      "type": "text",
      "id": "api_url",
      "label": "API URL (Advanced)",
      "info": "Leave blank to use default. Only change if instructed by support."
    },
    {
      "type": "checkbox",
      "id": "debug_mode",
      "label": "Debug mode",
      "default": false,
      "info": "Enable console logging for troubleshooting"
    }
  ]
}
{% endschema %}

