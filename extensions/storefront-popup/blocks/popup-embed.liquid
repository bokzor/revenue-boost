{%- comment -%}
  Revenue Boost App Block: Popup Embed
  This is the REQUIRED way to load JavaScript in Shopify theme extensions.
  Shopify does NOT allow automatic script injection via app embeds for security.
{%- endcomment -%}

{% if block.settings.enabled %}
  <div id="revenue-boost-embed" data-shop="{{ shop.permanent_domain }}" style="display: none;">
    <script>
      (function() {
        var debug = {{ block.settings.debug_mode | default: false }};

        function log() {
          if (debug && typeof console !== 'undefined' && console.log) {
            console.log.apply(console, ['[Revenue Boost]'].concat(Array.prototype.slice.call(arguments)));
          }
        }

        window.REVENUE_BOOST_CONFIG = window.REVENUE_BOOST_CONFIG || {};
        window.REVENUE_BOOST_CONFIG.apiUrl = '{{ block.settings.api_url | default: '' }}';
        window.REVENUE_BOOST_CONFIG.shopDomain = '{{ shop.permanent_domain }}';
        window.REVENUE_BOOST_CONFIG.debug = debug;
        window.REVENUE_BOOST_CONFIG.customerId = {{ customer.id | json }};
        window.REVENUE_BOOST_CONFIG.customerEmail = {{ customer.email | json }};
        window.REVENUE_BOOST_CONFIG.customerTags = {{ customer.tags | json }};
        window.REVENUE_BOOST_CONFIG.cartToken = {{ cart.token | json }};
        window.REVENUE_BOOST_CONFIG.pageType = '{{ request.page_type }}';
        window.REVENUE_BOOST_CONFIG.pageUrl = '{{ request.path }}';

        // Detect preview mode from URL parameter (token-based only)
        var urlParams = new URLSearchParams(window.location.search);
        var previewToken = urlParams.get('split_pop_preview_token');
        var previewBehavior = urlParams.get('preview_behavior') || 'instant';

        log('URL:', window.location.href);
        log('Preview params:', { previewToken: previewToken, previewBehavior: previewBehavior });

        if (previewToken) {
          log('✅ Setting preview mode with token:', previewToken);
          window.REVENUE_BOOST_CONFIG.previewMode = true;
          window.REVENUE_BOOST_CONFIG.previewToken = previewToken;
          window.REVENUE_BOOST_CONFIG.previewBehavior = previewBehavior;
        } else {
          log('ℹ️ No preview parameters found');
        }

        log('Final config:', {
          previewMode: window.REVENUE_BOOST_CONFIG.previewMode,
          previewToken: window.REVENUE_BOOST_CONFIG.previewToken,
          previewBehavior: window.REVENUE_BOOST_CONFIG.previewBehavior
        });
      })();
    </script>
    <script src="{{ 'popup-loader.bundle.js' | asset_url }}" defer></script>
  </div>
{% endif %}

{% schema %}
{
  "name": "Revenue Boost Popups",
  "target": "body",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable popups",
      "default": true,
      "info": "Turn off to disable all popups on your store"
    },
    {
      "type": "text",
      "id": "api_url",
      "label": "API URL (Advanced)",
      "info": "Leave blank to use default. Only change if instructed by support."
    },
    {
      "type": "checkbox",
      "id": "debug_mode",
      "label": "Debug mode",
      "default": false,
      "info": "Enable console logging for troubleshooting"
    }
  ]
}
{% endschema %}

