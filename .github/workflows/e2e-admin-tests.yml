name: ðŸ”§ E2E Admin Tests (Manual)

# =============================================================================
# MANUAL ONLY - Admin E2E Tests with TEST_MODE
# =============================================================================
# This workflow runs admin campaign creation tests using TEST_MODE.
# It starts a local server with Shopify auth bypassed, allowing automated testing.
#
# To run: Go to Actions â†’ "E2E Admin Tests (Manual)" â†’ "Run workflow"
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter pattern (e.g., "newsletter" or leave empty for all)'
        required: false
        default: ''
        type: string

env:
  NODE_VERSION: '24'

jobs:
  e2e-admin:
    name: E2E Admin Tests (TEST_MODE)
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: ðŸŽ­ Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      - name: ðŸŽ­ Install Playwright deps only (cached browsers)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: ðŸŒ± Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ—ï¸ Build the application
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY }}
          SHOPIFY_API_SECRET: ${{ secrets.SHOPIFY_API_SECRET }}

      - name: ðŸ—ï¸ Build storefront bundles
        run: npm run build:storefront
        env:
          BUILD_MODE: staging

      - name: ðŸ” Create environment file
        run: |
          cat > .env.staging.env << EOF
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          TEST_MODE=true
          TEST_SHOP_DOMAIN=revenue-boost-staging.myshopify.com
          EOF

      - name: ðŸš€ Start test server (port 3001)
        run: |
          # Start server on port 3001 with TEST_MODE
          PORT=3001 \
          TEST_MODE=true \
          TEST_SHOP_DOMAIN=revenue-boost-staging.myshopify.com \
          DATABASE_URL=${{ secrets.DATABASE_URL }} \
          SHOPIFY_API_KEY=${{ secrets.SHOPIFY_API_KEY }} \
          SHOPIFY_API_SECRET=${{ secrets.SHOPIFY_API_SECRET }} \
          SCOPES=read_products,write_products \
          SESSION_SECRET=test-session-secret-for-ci-testing-only \
          INTERNAL_API_SECRET=test-internal-api-secret-for-ci-testing \
          npm run start &

          # Wait for server to be ready
          echo "â³ Waiting for server to start on port 3001..."
          for i in {1..30}; do
            if curl -s http://localhost:3001 > /dev/null 2>&1; then
              echo "âœ… Server is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: ðŸ§ª Run Admin E2E Tests
        run: |
          TEST_FILTER="${{ inputs.test_filter }}"
          
          if [ -n "$TEST_FILTER" ]; then
            echo "ðŸ” Running tests matching: $TEST_FILTER"
            TEST_MODE=true TEST_SERVER_URL=http://localhost:3001 \
            npx playwright test --project=admin-ci -g "$TEST_FILTER" --retries=2
          else
            echo "ðŸ” Running all admin E2E tests"
            TEST_MODE=true TEST_SERVER_URL=http://localhost:3001 \
            npx playwright test --project=admin-ci --retries=2
          fi
        env:
          CI: true
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-admin-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 14

      - name: ðŸ“‹ Test Summary
        if: always()
        run: |
          echo "## ðŸ”§ E2E Admin Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests ran with TEST_MODE=true (Shopify auth bypassed)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“… Run at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”– Git SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

