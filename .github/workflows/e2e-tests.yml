# E2E Tests - Manual Trigger Only
#
# This workflow runs comprehensive end-to-end tests using self-hosted runners.
# All E2E tests must be triggered manually for security and resource management.
#
# Usage:
# 1. Go to Actions tab in GitHub
# 2. Select "E2E Tests (Manual)" workflow
# 3. Click "Run workflow"
# 4. Choose test suite, browser, and environment
# 5. Click "Run workflow" button
#
# Test Suites:
# - all: Run all test suites (e2e, mobile, performance, accessibility)
# - e2e-only: Run only standard E2E tests
# - mobile-only: Run only mobile responsiveness tests
# - performance-only: Run only performance tests
# - accessibility-only: Run only accessibility tests

name: E2E Tests (Manual)

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - e2e-only
          - mobile-only
          - performance-only
          - accessibility-only
      browser:
        description: 'Browser to test (for e2e-only)'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all-browsers
      environment:
        description: 'Test environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# Automatically cancel previous runs when new ones start
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  # Use test values if secrets are not available
  DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://test_user:test_password@localhost:5432/split_pop_test' }}
  REDIS_URL: ${{ secrets.REDIS_URL || 'redis://localhost:6379' }}
  SHOPIFY_API_KEY: ${{ secrets.SHOPIFY_API_KEY || '6b98534dfd8afd0ddf674ad6242a8e7e' }}
  SHOPIFY_API_SECRET: ${{ secrets.SHOPIFY_API_SECRET || '13d4387cbad759c4d836e6d2504a2a8e' }}
  BASE_URL: http://localhost:3000
  NODE_ENV: test
  CI: true

jobs:
  e2e-tests:
    name: E2E Tests (${{ matrix.browser }})
    runs-on: self-hosted
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'e2e-only' }}
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: split_pop_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    strategy:
      matrix:
        browser: ${{
          github.event.inputs.browser == 'all-browsers' && fromJSON('["chromium", "firefox", "webkit"]') ||
          github.event.inputs.browser == 'chromium' && fromJSON('["chromium"]') ||
          github.event.inputs.browser == 'firefox' && fromJSON('["firefox"]') ||
          github.event.inputs.browser == 'webkit' && fromJSON('["webkit"]') ||
          fromJSON('["chromium"]')
        }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          cat > .env << EOF
          # Test Environment Configuration
          DATABASE_URL="postgresql://test_user:test_password@localhost:5432/split_pop_test"
          REDIS_URL="redis://localhost:6379"
          NODE_ENV="test"
          BASE_URL="http://localhost:3000"
          SHOPIFY_APP_URL="http://localhost:3000"
          SHOPIFY_API_KEY="6b98534dfd8afd0ddf674ad6242a8e7e"
          SHOPIFY_API_SECRET="13d4387cbad759c4d836e6d2504a2a8e"
          SCOPES="write_products,write_customers,read_orders,write_script_tags,read_themes,write_discounts"
          SHOPIFY_SCOPES="write_products,write_customers,read_orders,write_script_tags,read_themes,write_discounts"
          SESSION_SECRET="test-session-secret-for-ci-only"
          INTERNAL_API_SECRET="test-internal-api-secret-for-ci-only"
          CI="true"
          SKIP_EXTERNAL_API_CALLS="true"
          MOCK_SHOPIFY_API="true"
          MOCK_EMAIL_SERVICE="true"
          MOCK_ANALYTICS="true"
          EOF

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Setup test database
        run: |
          npx prisma db push --force-reset
          npm run setup || echo "⚠️ Setup script failed, continuing..."

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Start application
        run: |
          npm run start &
          sleep 10 # Wait for server to start

      - name: Wait for server to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health || curl -f http://localhost:3000; do sleep 2; done' || echo "Server may not be ready"

      - name: Run E2E tests
        run: E2E_TEST_MODE=true npx playwright test --project=${{ matrix.browser }}
        env:
          CI: true
          E2E_TEST_MODE: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: test-results/
          retention-days: 7

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: html-report-${{ matrix.browser }}
          path: test-results/html-report/
          retention-days: 7

  mobile-tests:
    name: Mobile Tests
    runs-on: self-hosted
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'mobile-only' }}
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: split_pop_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          cat > .env << EOF
          # Test Environment Configuration
          DATABASE_URL="postgresql://test_user:test_password@localhost:5432/split_pop_test"
          REDIS_URL="redis://localhost:6379"
          NODE_ENV="test"
          BASE_URL="http://localhost:3000"
          SHOPIFY_APP_URL="http://localhost:3000"
          SHOPIFY_API_KEY="6b98534dfd8afd0ddf674ad6242a8e7e"
          SHOPIFY_API_SECRET="13d4387cbad759c4d836e6d2504a2a8e"
          SCOPES="write_products,write_customers,read_orders,write_script_tags,read_themes,write_discounts"
          SHOPIFY_SCOPES="write_products,write_customers,read_orders,write_script_tags,read_themes,write_discounts"
          SESSION_SECRET="test-session-secret-for-ci-only"
          INTERNAL_API_SECRET="test-internal-api-secret-for-ci-only"
          CI="true"
          SKIP_EXTERNAL_API_CALLS="true"
          MOCK_SHOPIFY_API="true"
          MOCK_EMAIL_SERVICE="true"
          MOCK_ANALYTICS="true"
          EOF

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Setup test database
        run: |
          npx prisma db push --force-reset
          npm run setup || echo "⚠️ Setup script failed, continuing..."

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Start application
        run: |
          npm run start &
          sleep 10

      - name: Wait for server to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health || curl -f http://localhost:3000; do sleep 2; done' || echo "Server may not be ready"

      - name: Run mobile tests
        run: |
          echo "Available scripts:"
          npm run
          echo "Running mobile tests..."
          E2E_TEST_MODE=true npm run test:e2e:mobile || E2E_TEST_MODE=true npx playwright test --project='Mobile Chrome' --project='Mobile Safari' --project='Tablet'
        env:
          CI: true
          E2E_TEST_MODE: true

      - name: Upload mobile test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobile-test-results
          path: test-results/
          retention-days: 7

  performance-tests:
    name: Performance Tests
    runs-on: self-hosted
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'performance-only' }}
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: split_pop_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          cat > .env << EOF
          # Test Environment Configuration
          DATABASE_URL="postgresql://test_user:test_password@localhost:5432/split_pop_test"
          REDIS_URL="redis://localhost:6379"
          NODE_ENV="test"
          BASE_URL="http://localhost:3000"
          SHOPIFY_APP_URL="http://localhost:3000"
          SHOPIFY_API_KEY="6b98534dfd8afd0ddf674ad6242a8e7e"
          SHOPIFY_API_SECRET="13d4387cbad759c4d836e6d2504a2a8e"
          SCOPES="write_products,write_customers,read_orders,write_script_tags,read_themes,write_discounts"
          SHOPIFY_SCOPES="write_products,write_customers,read_orders,write_script_tags,read_themes,write_discounts"
          SESSION_SECRET="test-session-secret-for-ci-only"
          INTERNAL_API_SECRET="test-internal-api-secret-for-ci-only"
          CI="true"
          SKIP_EXTERNAL_API_CALLS="true"
          MOCK_SHOPIFY_API="true"
          MOCK_EMAIL_SERVICE="true"
          MOCK_ANALYTICS="true"
          EOF

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Setup test database
        run: |
          npx prisma db push --force-reset
          npm run setup || echo "⚠️ Setup script failed, continuing..."

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Start application
        run: |
          npm run start &
          sleep 10

      - name: Wait for server to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health || curl -f http://localhost:3000; do sleep 2; done' || echo "Server may not be ready"

      - name: Run performance tests
        run: E2E_TEST_MODE=true npm run test:e2e:performance
        env:
          CI: true
          E2E_TEST_MODE: true

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-test-results
          path: test-results/
          retention-days: 7

  accessibility-tests:
    name: Accessibility Tests
    runs-on: self-hosted
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'accessibility-only' }}
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: split_pop_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment
        run: |
          cat > .env << EOF
          # Test Environment Configuration
          DATABASE_URL="postgresql://test_user:test_password@localhost:5432/split_pop_test"
          REDIS_URL="redis://localhost:6379"
          NODE_ENV="test"
          BASE_URL="http://localhost:3000"
          SHOPIFY_APP_URL="http://localhost:3000"
          SHOPIFY_API_KEY="6b98534dfd8afd0ddf674ad6242a8e7e"
          SHOPIFY_API_SECRET="13d4387cbad759c4d836e6d2504a2a8e"
          SCOPES="write_products,write_customers,read_orders,write_script_tags,read_themes,write_discounts"
          SHOPIFY_SCOPES="write_products,write_customers,read_orders,write_script_tags,read_themes,write_discounts"
          SESSION_SECRET="test-session-secret-for-ci-only"
          INTERNAL_API_SECRET="test-internal-api-secret-for-ci-only"
          CI="true"
          SKIP_EXTERNAL_API_CALLS="true"
          MOCK_SHOPIFY_API="true"
          MOCK_EMAIL_SERVICE="true"
          MOCK_ANALYTICS="true"
          EOF

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Setup test database
        run: |
          npx prisma db push --force-reset
          npm run setup || echo "⚠️ Setup script failed, continuing..."

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Start application
        run: |
          npm run start &
          sleep 10

      - name: Wait for server to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health || curl -f http://localhost:3000; do sleep 2; done' || echo "Server may not be ready"

      - name: Run accessibility tests
        run: E2E_TEST_MODE=true npm run test:e2e:accessibility
        env:
          CI: true
          E2E_TEST_MODE: true

      - name: Upload accessibility results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-test-results
          path: test-results/
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: self-hosted
    needs: [e2e-tests, mobile-tests, performance-tests, accessibility-tests]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-test-results/

      - name: Generate test summary
        run: |
          echo "# E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count test results
          if [ -f "all-test-results/html-report-chromium/index.html" ]; then
            echo "✅ Chromium E2E Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Chromium E2E Tests: Failed or No Results" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "all-test-results/mobile-test-results/junit.xml" ]; then
            echo "✅ Mobile Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Mobile Tests: Failed or No Results" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "all-test-results/performance-test-results/results.json" ]; then
            echo "✅ Performance Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Performance Tests: Failed or No Results" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "all-test-results/accessibility-test-results/results.json" ]; then
            echo "✅ Accessibility Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Accessibility Tests: Failed or No Results" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## View Detailed Reports" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifacts from the Actions tab to view detailed test reports." >> $GITHUB_STEP_SUMMARY

  notify-slack:
    name: Notify Slack
    runs-on: self-hosted
    needs: [e2e-tests, mobile-tests, performance-tests, accessibility-tests]
    if: always()

    steps:
      - name: Notify Slack on Success
        if: needs.e2e-tests.result == 'success' && needs.mobile-tests.result == 'success' && needs.performance-tests.result == 'success' && needs.accessibility-tests.result == 'success'
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"✅ Manual E2E tests (${{ github.event.inputs.test_suite }}) passed for ${{ github.repository }} on ${{ github.ref_name }} - Environment: ${{ github.event.inputs.environment }}"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure
        if: needs.e2e-tests.result == 'failure' || needs.mobile-tests.result == 'failure' || needs.performance-tests.result == 'failure' || needs.accessibility-tests.result == 'failure'
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"❌ Manual E2E tests (${{ github.event.inputs.test_suite }}) failed for ${{ github.repository }} on ${{ github.ref_name }} - Environment: ${{ github.event.inputs.environment }}. Check the GitHub Actions for details."}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
