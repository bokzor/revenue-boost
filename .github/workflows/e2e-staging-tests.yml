name: ðŸ§ª E2E Staging Tests (Optional)

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter pattern (e.g., "newsletter" or leave empty for all)'
        required: false
        default: ''
        type: string
      headed:
        description: 'Run in headed mode (for debugging)'
        required: false
        default: false
        type: boolean
  
  # Can be called from other workflows (e.g., after deploy)
  workflow_call:
    inputs:
      test_filter:
        description: 'Test filter pattern'
        required: false
        default: ''
        type: string
    secrets:
      DATABASE_URL:
        required: true
      REDIS_URL:
        required: false
      STORE_PASSWORD:
        required: false

# Prevent concurrent E2E runs
concurrency:
  group: e2e-staging-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '24'

jobs:
  e2e-staging:
    name: E2E Staging Tests
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: ðŸŽ­ Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      - name: ðŸŽ­ Install Playwright deps only (cached browsers)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: ðŸŒ± Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ—ï¸ Build storefront bundles
        run: npm run build:storefront
        env:
          BUILD_MODE: staging

      - name: ðŸ” Create environment file from secrets
        run: |
          cat > .env.staging.env << EOF
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          REDIS_URL=${{ secrets.REDIS_URL || '' }}
          STORE_PASSWORD=${{ secrets.STORE_PASSWORD || 'a' }}
          SHOPIFY_API_KEY=${{ secrets.SHOPIFY_API_KEY || '' }}
          SHOPIFY_API_SECRET=${{ secrets.SHOPIFY_API_SECRET || '' }}
          EOF

          echo "âœ… Environment file created"
          echo "DATABASE_URL length: $(echo -n '${{ secrets.DATABASE_URL }}' | wc -c)"

      - name: ðŸŒ± Ensure test prerequisites exist in database
        run: |
          echo "Ensuring store and templates exist for E2E tests..."
          npx tsx scripts/seed-e2e-prerequisites.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: ðŸ§ª Run E2E Storefront Tests
        run: |
          TEST_FILTER="${{ inputs.test_filter || github.event.inputs.test_filter }}"

          if [ -n "$TEST_FILTER" ]; then
            echo "ðŸ” Running tests matching: $TEST_FILTER"
            npx playwright test tests/e2e/staging/ --project=storefront -g "$TEST_FILTER" --retries=2
          else
            echo "ðŸ” Running all staging E2E tests"
            # Run all staging tests with 2 retries for flaky tests
            npx playwright test tests/e2e/staging/ --project=storefront --retries=2
          fi
        env:
          CI: true
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 14

      - name: ðŸ“‹ Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª E2E Staging Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "test-results/reports/results.json" ]; then
            PASSED=$(cat test-results/reports/results.json | jq '.stats.expected // 0')
            FAILED=$(cat test-results/reports/results.json | jq '.stats.unexpected // 0')
            SKIPPED=$(cat test-results/reports/results.json | jq '.stats.skipped // 0')
            
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No test results found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“… Run at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”– Git SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

