# Popup Primitives Implementation - Shadow DOM Compatible

## Overview

All popup primitives have been implemented using **inline styles + injected `<style>` tags** to ensure Shadow DOM compatibility.

## Why This Approach?

Since storefront popups render inside Shadow DOM (see `PopupPortal.tsx`), we cannot use:
- ❌ CSS Modules (styles won't be injected into shadow root)
- ❌ Global stylesheets (shadow boundary blocks them)
- ❌ External CSS files

Instead, we use:
- ✅ Inline styles via React `style` prop
- ✅ CSS variables from `theme.ts` for design tokens
- ✅ Injected `<style>` tags for container queries, pseudo-elements, and animations

## Components

### PopupCard
- **File**: `app/domains/storefront/popups-new/components/primitives/PopupCard.tsx`
- **Approach**: Inline styles + injected container query styles
- **Key Features**:
  - CSS variables for colors, spacing, fonts (from `varsFromDesign`)
  - Inline grid layout with `gap`, `padding`, `maxWidth`
  - Container queries injected via `<style>` tag for responsive grid columns
  - Variant-specific max-widths (e.g., cart variant: 640px/840px)

### PopupButton
- **File**: `PopupButton.tsx`
- **Approach**: Pure inline styles with JavaScript hover handlers
- **Key Features**:
  - Variant styles (primary, secondary, ghost, danger) via object lookup
  - Size styles (sm, md, lg) via object lookup
  - Hover effects via `onMouseEnter`/`onMouseLeave`
  - Can render as `<a>` or `<button>` based on `href` prop

### PopupInput
- **File**: `PopupInput.tsx`
- **Approach**: Inline styles with focus/blur handlers
- **Key Features**:
  - Error state via conditional border color
  - Focus ring via `onFocus`/`onBlur` handlers
  - Label and error message with proper ARIA associations

### PopupHeading & PopupText
- **Files**: `PopupHeading.tsx`, `PopupText.tsx`
- **Approach**: Inline base styles + injected container query scaling
- **Key Features**:
  - Base font size via inline styles
  - Responsive scaling via `<style>` with `@container` queries
  - Tone colors via CSS variables

### CloseButton
- **File**: `CloseButton.tsx`
- **Approach**: Inline styles with React state for hover
- **Key Features**:
  - 44x44px hit area
  - Hover state via `useState` hook
  - Focus ring via handlers

## CSS Variables System

All components consume CSS variables generated by `varsFromDesign()`:

```typescript
{
  '--rb-popup-bg': design.backgroundColor,
  '--rb-popup-fg': design.textColor,
  '--rb-popup-description-fg': design.descriptionColor,
  '--rb-popup-primary-bg': design.buttonColor,
  '--rb-popup-primary-fg': design.buttonTextColor,
  '--rb-popup-accent': design.accentColor,
  '--rb-popup-success': design.successColor,
  '--rb-popup-error': '#b91c1c',
  '--rb-popup-input-bg': design.inputBackgroundColor,
  '--rb-popup-input-fg': design.inputTextColor,
  '--rb-popup-input-border': design.inputBorderColor,
  '--rb-popup-radius': design.borderRadius,
  '--rb-popup-font-family': design.fontFamily,
  '--rb-popup-max-w': /* size-based: 400px/600px/800px */,
  '--rb-popup-padding': /* size-based: 1.25rem/1.5rem/2rem */,
  '--rb-popup-gap': '1.5rem',
}
```

## Container Queries in Shadow DOM

Container queries work in Shadow DOM, but must be injected via `<style>` tags:

```tsx
<>
  <style>{`
    [data-popup-card] {
      container-type: inline-size;
      container-name: popup-card;
    }
    
    @container popup-card (min-width: 480px) {
      [data-popup-heading] {
        font-size: 1.75rem;
      }
    }
  `}</style>
  
  <div data-popup-card style={inlineStyles}>
    <h2 data-popup-heading>Heading</h2>
  </div>
</>
```

## Testing

All primitives work correctly in tests:
- ✅ 40 tests passing (12 test files)
- ✅ Unit tests for each primitive component
- ✅ Integration tests for CartAbandonmentPopup refactor

Run: `npm run test:run -- tests/unit/domains/storefront/popups-new/`

## Benefits

1. **Shadow DOM Compatible**: Styles work correctly in isolated shadow root
2. **Lean Bundle**: No CSS-in-JS library overhead
3. **Theme-Driven**: Single source of truth via `PopupDesignConfig`
4. **Type-Safe**: Full TypeScript support
5. **Accessible**: Proper ARIA, focus management, 44px touch targets
6. **Responsive**: Container queries for card-width-based scaling

## Migration Path

To migrate other popups to these primitives:

1. Replace custom card container with `<PopupCard design={config} size={config.size}>`
2. Replace headings with `<PopupHeading>`
3. Replace text with `<PopupText tone="subdued">` for subtext
4. Replace buttons with `<PopupButton variant="primary" fullWidth>`
5. Replace inputs with `<PopupInput errorText={error} fullWidth>`
6. Replace close buttons with `<CloseButton onClick={onClose} />`
7. Remove custom CSS/styles files
8. Test in both admin preview and actual storefront (Shadow DOM)

## Next Steps

- [ ] Refactor Newsletter popup to use primitives
- [ ] Refactor other modal popups (Upsell, Scratch, Spin)
- [ ] Consider extracting inline styles to shared utilities if patterns emerge
- [ ] Document any Shadow DOM gotchas discovered during rollout
